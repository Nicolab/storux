/*! storux v0.11.1 | MIT (c) 2021 Nicolas Tallefourtane - https://github.com/Nicolab/storux */
var __defProp=Object.defineProperty,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(t,e,i)=>e in t?__defProp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,__spreadValues=(t,e)=>{for(var i in e||(e={}))__hasOwnProp.call(e,i)&&__defNormalProp(t,i,e[i]);if(__getOwnPropSymbols)for(var i of __getOwnPropSymbols(e))__propIsEnum.call(e,i)&&__defNormalProp(t,i,e[i]);return t};!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).storux={})}(this,(function(t){"use strict";function e(t,...e){return e.forEach((e=>{let i=Object.keys(e).reduce((function(t,i){return t[i]=Object.getOwnPropertyDescriptor(e,i),t}),{});Object.getOwnPropertySymbols(e).forEach((function(t){let o=Object.getOwnPropertyDescriptor(e,t);o.enumerable&&(i[t]=o)})),Object.defineProperties(t,i)})),t}function i(t){return"string"==typeof t?t:t.id}function o(t){let e=t.displayName||t.name;return e||(e=/^function\s+([\w$]+)\s*\(/.exec(t.toString()),e?e[1]:null)}function s(t,e){Object.defineProperty(t,"displayName",{enumerable:!0,configurable:!1,writable:!1,value:e})}function r(t){return t instanceof l==!0}const n=require("evemit");function a(){throw new ReferenceError("No action in progress")}class c{constructor({store:t,opt:i}){this.storux=i.storux,i.storux=null,this.opt=i,this.store=t,this.initialState=this.opt.initialState?e({},this.opt.initialState):{},this.clone=e,this.dispatch=a,this._lc=new n,this.on=this._lc.on.bind(this._lc),this.once=this._lc.once.bind(this._lc),this.off=this._lc.off.bind(this._lc),this.emit=this._lc.emit.bind(this._lc),this.listeners=this._lc.listeners.bind(this._lc),s(this,this.opt.displayName?this.opt.displayName:function(t){return(e=t.displayName||o(t.constructor)).charAt(0).toLowerCase()+e.substr(1);var e}(this.store)),this._p={aq:[],ca:null,cl:[]},this.on("init",(()=>{this.dispatch=a,this._p.ca=null,this._p.state=e({},this.initialState)}))}listen(t){if("function"!=typeof t)throw new TypeError(this.displayName+": listener must be a function.");return this._p.cl.push(t),this.emit("listen",t),()=>this.unlisten(t)}unlisten(t){let e=this._p.cl,i=e.indexOf(t);return-1!==i&&(e.splice(i,1),this.emit("unlisten",t),!0)}getState(){return e({},this._p.state)}replaceState(t={}){let i,o;if(function(t,e){let i=Object.getOwnPropertyNames(t),o=Object.getOwnPropertyNames(e),s=i.length;if(s!==o.length)return!1;for(let r=0;r<s;r++){let o=i[r];if(t[o]!==e[o])return!1}return!0}(this._p.state,t))return!1;if(this._p.state=e({},t),i=this._p.cl.length,i){o=this._p.cl;for(let t=0;t<i;t++)"function"==typeof o[t]?o[t](this.store):o.splice(t,1)}return!0}setState(t){return this.replaceState(__spreadValues(__spreadValues({},this._p.state),t))}resetState(){let t=this.replaceState(this.initialState);return t&&this.emit("resetState"),t}recycle(){let t=this.replaceState(this.initialState);return this.emit("init",t),t}save(t,e){if(!this.dispatch._action||!this._p.ca)throw new ReferenceError("No action in progress.");if(this.dispatch._action.hooks.length)throw new TypeError("This action have one or more hooks. Use dispatch() instead save().");if("object"!=typeof t)throw new TypeError("save() require an object in "+this.dispatch._action.id);return this.dispatch(e,t)}_dispatcher({resolve:t,action:e,payload:i,obj:o,fnResult:s}){let r;const n=this;if(n.dispatch._inProgress)throw new Error("Dispatching in progress: "+e.id+" The dispatcher must be called only once by action.");return n.dispatch._inProgress=!0,r=e.hooks.length?this._reduceActionHooks(e,i):!!o&&this.setState(o),n.dispatch=a,t(s),n.storux.emit("after."+e.id,i,s,r),n.storux.emit("after",{actionId:e.id,actionName:e.displayName,result:s,payload:i,hasChanged:r}),n._p.ca=null,n._next(),r}_next(){return!(!this._p.aq.length||this.dispatch._action||this._p.ca)&&(this._p.aq.shift()(),!0)}_createActionProxy(t){const e=(...i)=>new Promise((o=>{const s=this;this._p.aq.push((function(){if(s.dispatch._action||s._p.ca)throw new Error(e.id+" can be called, because the action "+s.dispatch._action.id+" is not finished");s.dispatch=function(t,i){return new Promise((function(n){setImmediate((function(){n(s._dispatcher({resolve:o,action:e,payload:t,obj:i,fnResult:r}))}))}))},s.dispatch._action=e,s._p.ca=e.id,i=i.slice(),s.storux.emit("before."+e.id,i),s.storux.emit("before",{actionId:e.id,actionName:e.displayName,actionArgs:i});const r=t.apply(s.store,i)})),1===this._p.aq.length&&this._next()}));return e}_getHandlerArgs({action:t,payload:e,nextState:i}){return[i,e,{actionId:t.id,actionName:t.displayName}]}_reduceActionHooks(t,e){let i=this.getState();for(let s=0,r=t.hooks.length;s<r;s++){let r=t.hooks[s];if("function"!=typeof r)throw new TypeError("The hook must be a function. Hook type: "+typeof r);let n=r.apply(this.store,this._getHandlerArgs({action:t,payload:e,nextState:i}));if(!n||"object"!=typeof n)throw new TypeError('The hook "'+o(r)+'" should return the next state for the action '+t.id);i=n}return this.replaceState(i)}mountAction(t,e){if(this.store[t]&&this.store[t].id)return this;const i=this._createActionProxy(e);s(i,t);let r=o(e);return r&&"function"==typeof this.store[r]&&(this.store[r]=void 0),i.id=this.displayName+"."+i.displayName,i.defer=(...t)=>setImmediate(i.apply(this.store,t)),i.hooks=[],this.store[t]=i,this}mountActions(t){if("object"!=typeof t)throw new ReferenceError("mountActions() requiere one or more actions to mount");for(let e in t)this.mountAction(e,t[e]);return this}ensureActions(){return this._generateActions("dispatch",arguments)}ensureSaveActions(){return this._generateActions("save",arguments)}_generateActions(t,e){let i=this.store;for(let o=0,s=e.length;o<s;o++){let s=e[o];i[s]||(i[s]=function(e){return"save"===t?i.scope.save(e,e):i.scope.dispatch(e),e},this.mountAction(s,i[s]))}return this}}const h=function(t,e,i,o){Object.defineProperty(e,o||i,{enumerable:!1,configurable:!1,writable:!1,value:t[i].bind(t)})};class l{constructor(t={}){let e=new l.Scope({store:this,opt:t});Object.defineProperty(this,"scope",{enumerable:!0,configurable:!1,writable:!1,value:e}),h(e,this,"getState"),h(e,this,"setState"),h(e,this,"replaceState"),this._mount()}_dispatch(t,e){return this.scope.dispatch(t,e)}_save(t,e){return this.scope.save(t,e)}_mount(){let t=[];for(let e in this._mount){let i=this._mount[e];"action"!==i.type?"hook"===i.type&&t.push(i):this.scope.mountAction(i.name,i.fn)}for(let e=0,i=t.length;e<i;e++)this[t[e].actionName].hooks.push(this[t[e].key]);this._mount=void 0}}l.Scope=c;const u=require("evemit");class p{constructor(){this.stores={},this.Store=p.Store,this._lc=new u,this.on=this._lc.on.bind(this._lc),this.once=this._lc.once.bind(this._lc),this.off=this._lc.off.bind(this._lc),this.emit=this._lc.emit.bind(this._lc),this.listeners=this._lc.listeners.bind(this._lc)}create(t,e={}){let i,o;if(e.storux=this,o=new t(e),!r(o))throw new TypeError("Storux.create() - `store` argument must be an instance of `Store`");if(i=o.scope.displayName,this.stores[i])throw new Error("The store `"+i+"` is already defined in the `Storux` instance.");return Object.defineProperty(this.stores,i,{enumerable:!0,configurable:!1,writable:!1,value:o}),this.emit("create",this.stores[i]),this.emit("create."+i,this.stores[i]),p.removeScopePropsAfterCreation.forEach((function(t){o.scope[t]=void 0})),o.scope.emit("init"),this.stores[i]}before(t,e,o){return this.on("before."+i(t),e,o),this}offBefore(t,e){return this.off("before."+i(t),e),this}after(t,e,o){return this.on("after."+i(t),e,o),this}offAfter(t,e){return this.off("after."+i(t),e),this}beforeEach(t,e){return this.on("before",t,e),this}offBeforeEach(t){return this.off("before",t),this}afterEach(t,e){return this.on("after",t,e),this}offAfterEach(t){return this.off("after",t),this}}p.Store=l,p.isStore=r,p.removeScopePropsAfterCreation=["_createActionProxy","_generateActions","ensureActions","ensureSaveActions","mountAction","mountActions"],t.Scope=c,t.Store=l,t.Storux=p,t.action=function(t){return function(e,i){e._mount[i]={type:"action",name:t,fn:e[i]}}},t.hook=function(t){return function(e,i){e._mount[i]={type:"hook",key:i,actionName:t}}},Object.defineProperty(t,"__esModule",{value:!0}),t[Symbol.toStringTag]="Module"}));
