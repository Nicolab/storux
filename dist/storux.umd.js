/*! storux v0.11.3 | MIT (c) 2021 Nicolas Tallefourtane - https://github.com/Nicolab/storux */
var __defProp=Object.defineProperty,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(t,e,i)=>e in t?__defProp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,__spreadValues=(t,e)=>{for(var i in e||(e={}))__hasOwnProp.call(e,i)&&__defNormalProp(t,i,e[i]);if(__getOwnPropSymbols)for(var i of __getOwnPropSymbols(e))__propIsEnum.call(e,i)&&__defNormalProp(t,i,e[i]);return t};!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).storux={})}(this,(function(t){"use strict";var e,i={exports:{}};
/**
   * @name Evemit
   * @description Minimal and fast JavaScript event emitter for Node.js and front-end.
   * @author Nicolas Tallefourtane <dev@nicolab.net>
   * @link https://github.com/Nicolab/evemit
   * @license MIT https://github.com/Nicolab/evemit/blob/master/LICENSE
   */e=i,function(){function t(){this.events={}}t.prototype.on=function(t,e,i){return this.events[t]||(this.events[t]=[]),i&&(e._E_ctx=i),this.events[t].push(e),this},t.prototype.once=function(t,e,i){return e._E_once=!0,this.on(t,e,i)},t.prototype.emit=function(t,e,i,s,o){var r,n,a,c;if(!this.events[t])return!1;c=(a=Array.prototype.slice.call(arguments,1)).length;for(var h=0,l=(n=this.events[t]).length;h<l;h++)switch((r=n[h])._E_once&&this.off(t,r),c){case 0:r.call(r._E_ctx);break;case 1:r.call(r._E_ctx,e);break;case 2:r.call(r._E_ctx,e,i);break;case 3:r.call(r._E_ctx,e,i,s);break;case 4:r.call(r._E_ctx,e,i,s,o);break;default:r.apply(r._E_ctx,a)}return!0},t.prototype.off=function(t,e){if(!this.events[t])return this;for(var i=0,s=this.events[t].length;i<s;i++)this.events[t][i]===e&&(this.events[t][i]=null,delete this.events[t][i]);return this.events[t]=this.events[t].filter((function(t){return void 0!==t})),this},t.prototype.listeners=function(t){var e,i;if(t)return this.events[t]||[];for(var s in i=[],e=this.events)i=i.concat(e[s].valueOf());return i},e.exports?e.exports=t:window.Evemit=t}();var s=i.exports;function o(t,...e){return e.forEach((e=>{let i=Object.keys(e).reduce((function(t,i){return t[i]=Object.getOwnPropertyDescriptor(e,i),t}),{});Object.getOwnPropertySymbols(e).forEach((function(t){let s=Object.getOwnPropertyDescriptor(e,t);s.enumerable&&(i[t]=s)})),Object.defineProperties(t,i)})),t}function r(t){return"string"==typeof t?t:t.id}function n(t){let e=t.displayName||t.name;return e||(e=/^function\s+([\w$]+)\s*\(/.exec(t.toString()),e?e[1]:null)}function a(t,e){Object.defineProperty(t,"displayName",{enumerable:!0,configurable:!1,writable:!1,value:e})}function c(t){return t instanceof p==!0}function h(){throw new ReferenceError("No action in progress")}class l{constructor({store:t,opt:e}){this.storux=e.storux,e.storux=null,this.opt=e,this.store=t,this.initialState=this.opt.initialState?o({},this.opt.initialState):{},this.clone=o,this.dispatch=h,this._lc=new s,this.on=this._lc.on.bind(this._lc),this.once=this._lc.once.bind(this._lc),this.off=this._lc.off.bind(this._lc),this.emit=this._lc.emit.bind(this._lc),this.listeners=this._lc.listeners.bind(this._lc),a(this,this.opt.displayName?this.opt.displayName:function(t){return(e=t.displayName||n(t.constructor)).charAt(0).toLowerCase()+e.substr(1);var e}(this.store)),this._p={aq:[],ca:null,cl:[]},this.on("init",(()=>{this.dispatch=h,this._p.ca=null,this._p.state=o({},this.initialState)}))}listen(t){if("function"!=typeof t)throw new TypeError(this.displayName+": listener must be a function.");return this._p.cl.push(t),this.emit("listen",t),()=>this.unlisten(t)}unlisten(t){let e=this._p.cl,i=e.indexOf(t);return-1!==i&&(e.splice(i,1),this.emit("unlisten",t),!0)}getState(){return o({},this._p.state)}replaceState(t={}){let e,i;if(function(t,e){let i=Object.getOwnPropertyNames(t),s=Object.getOwnPropertyNames(e),o=i.length;if(o!==s.length)return!1;for(let r=0;r<o;r++){let s=i[r];if(t[s]!==e[s])return!1}return!0}(this._p.state,t))return!1;if(this._p.state=o({},t),e=this._p.cl.length,e){i=this._p.cl;for(let t=0;t<e;t++)"function"==typeof i[t]?i[t](this.store):i.splice(t,1)}return!0}setState(t){return this.replaceState(__spreadValues(__spreadValues({},this._p.state),t))}resetState(){let t=this.replaceState(this.initialState);return t&&this.emit("resetState"),t}recycle(){let t=this.replaceState(this.initialState);return this.emit("init",t),t}save(t,e){if(!this.dispatch._action||!this._p.ca)throw new ReferenceError("No action in progress.");if(this.dispatch._action.hooks.length)throw new TypeError("This action have one or more hooks. Use dispatch() instead save().");if("object"!=typeof t)throw new TypeError("save() require an object in "+this.dispatch._action.id);return this.dispatch(e,t)}_dispatcher({resolve:t,action:e,payload:i,obj:s,fnResult:o}){let r;const n=this;if(n.dispatch._inProgress)throw new Error("Dispatching in progress: "+e.id+" The dispatcher must be called only once by action.");return n.dispatch._inProgress=!0,r=e.hooks.length?this._reduceActionHooks(e,i):!!s&&this.setState(s),n.dispatch=h,t(o),n.storux.emit("after."+e.id,i,o,r),n.storux.emit("after",{actionId:e.id,actionName:e.displayName,result:o,payload:i,hasChanged:r}),n._p.ca=null,n._next(),r}_next(){return!(!this._p.aq.length||this.dispatch._action||this._p.ca)&&(this._p.aq.shift()(),!0)}_createActionProxy(t){const e=(...i)=>new Promise((s=>{const o=this;this._p.aq.push((function(){if(o.dispatch._action||o._p.ca)throw new Error(e.id+" can be called, because the action "+o.dispatch._action.id+" is not finished");o.dispatch=function(t,i){return new Promise((function(n){setImmediate((function(){n(o._dispatcher({resolve:s,action:e,payload:t,obj:i,fnResult:r}))}))}))},o.dispatch._action=e,o._p.ca=e.id,i=i.slice(),o.storux.emit("before."+e.id,i),o.storux.emit("before",{actionId:e.id,actionName:e.displayName,actionArgs:i});const r=t.apply(o.store,i)})),1===this._p.aq.length&&this._next()}));return e}_getHandlerArgs({action:t,payload:e,nextState:i}){return[i,e,{actionId:t.id,actionName:t.displayName}]}_reduceActionHooks(t,e){let i=this.getState();for(let s=0,o=t.hooks.length;s<o;s++){let o=t.hooks[s];if("function"!=typeof o)throw new TypeError("The hook must be a function. Hook type: "+typeof o);let r=o.apply(this.store,this._getHandlerArgs({action:t,payload:e,nextState:i}));if(!r||"object"!=typeof r)throw new TypeError('The hook "'+n(o)+'" should return the next state for the action '+t.id);i=r}return this.replaceState(i)}mountAction(t,e){if(this.store[t]&&this.store[t].id)return this;const i=this._createActionProxy(e);a(i,t);let s=n(e);return s&&"function"==typeof this.store[s]&&(this.store[s]=void 0),i.id=this.displayName+"."+i.displayName,i.defer=(...t)=>setImmediate(i.apply(this.store,t)),i.hooks=[],this.store[t]=i,this}mountActions(t){if("object"!=typeof t)throw new ReferenceError("mountActions() requiere one or more actions to mount");for(let e in t)this.mountAction(e,t[e]);return this}ensureActions(){return this._generateActions("dispatch",arguments)}ensureSaveActions(){return this._generateActions("save",arguments)}_generateActions(t,e){let i=this.store;for(let s=0,o=e.length;s<o;s++){let o=e[s];i[o]||(i[o]=function(e){return"save"===t?i.scope.save(e,e):i.scope.dispatch(e),e},this.mountAction(o,i[o]))}return this}}const u=function(t,e,i,s){Object.defineProperty(e,s||i,{enumerable:!1,configurable:!1,writable:!1,value:t[i].bind(t)})};class p{constructor(t={}){let e=new p.Scope({store:this,opt:t});Object.defineProperty(this,"scope",{enumerable:!0,configurable:!1,writable:!1,value:e}),u(e,this,"getState"),u(e,this,"setState"),u(e,this,"replaceState"),this._mount()}_dispatch(t,e){return this.scope.dispatch(t,e)}_save(t,e){return this.scope.save(t,e)}_mount(){let t=[];for(let e in this._mount){let i=this._mount[e];"action"!==i.type?"hook"===i.type&&t.push(i):this.scope.mountAction(i.name,i.fn)}for(let e=0,i=t.length;e<i;e++)this[t[e].actionName].hooks.push(this[t[e].key]);this._mount=void 0}}p.Scope=l;class f{constructor(){this.stores={},this.Store=f.Store,this._lc=new s,this.on=this._lc.on.bind(this._lc),this.once=this._lc.once.bind(this._lc),this.off=this._lc.off.bind(this._lc),this.emit=this._lc.emit.bind(this._lc),this.listeners=this._lc.listeners.bind(this._lc)}create(t,e={}){let i,s;if(e.storux=this,s=new t(e),!c(s))throw new TypeError("Storux.create() - `store` argument must be an instance of `Store`");if(i=s.scope.displayName,this.stores[i])throw new Error("The store `"+i+"` is already defined in the `Storux` instance.");return Object.defineProperty(this.stores,i,{enumerable:!0,configurable:!1,writable:!1,value:s}),this.emit("create",this.stores[i]),this.emit("create."+i,this.stores[i]),f.removeScopePropsAfterCreation.forEach((function(t){s.scope[t]=void 0})),s.scope.emit("init"),this.stores[i]}before(t,e,i){return this.on("before."+r(t),e,i),this}offBefore(t,e){return this.off("before."+r(t),e),this}after(t,e,i){return this.on("after."+r(t),e,i),this}offAfter(t,e){return this.off("after."+r(t),e),this}beforeEach(t,e){return this.on("before",t,e),this}offBeforeEach(t){return this.off("before",t),this}afterEach(t,e){return this.on("after",t,e),this}offAfterEach(t){return this.off("after",t),this}}f.Store=p,f.isStore=c,f.removeScopePropsAfterCreation=["_createActionProxy","_generateActions","ensureActions","ensureSaveActions","mountAction","mountActions"],t.Scope=l,t.Store=p,t.Storux=f,t.action=function(t){return function(e,i){e._mount[i]={type:"action",name:t,fn:e[i]}}},t.hook=function(t){return function(e,i){e._mount[i]={type:"hook",key:i,actionName:t}}},Object.defineProperty(t,"__esModule",{value:!0}),t[Symbol.toStringTag]="Module"}));
